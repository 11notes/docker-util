#!/bin/sh
  FN=$(echo "${1}" | tr '[:upper:]' '[:lower:]')
  shift

  case "${FN}" in
    "asset")
      GITHUB_ASSET_SHA256=$(/usr/local/bin/curl -s -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/${1}/releases | /usr/local/bin/jq --raw-output '.[] | select(.tag_name == "'${2}'") | .assets[] | select(.name == "'${3}'") | .digest' | sed 's/sha256://')
      GITHUB_ASSET_URL=$(/usr/local/bin/curl -s -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/${1}/releases | /usr/local/bin/jq --raw-output '.[] | select(.tag_name == "'${2}'") | .assets[] | select(.name == "'${3}'") | .browser_download_url')
      
      if ! echo "${GITHUB_ASSET_URL}" | grep -q "https"; then
        GITHUB_ASSET_URL=https://github.com/${1}/archive/refs/tags/${3}
        eleven log warning "could not get a release for ${1}"
      fi

      GITHUB_ASSET=$(echo ${GITHUB_ASSET_URL} | awk -F '/' '{print $NF}')
      GITHUB_ASSET_EXTENSION=$(echo ${GITHUB_ASSET} | awk -F '.'  '{print $NF}')
      eleven log info "downloading ${GITHUB_ASSET} from github ..."
      /usr/local/bin/curl -sSL ${GITHUB_ASSET_URL} -o ${GITHUB_ASSET}

      if [ $(echo "${GITHUB_ASSET_SHA256}" | wc -m) -ge 64 ]; then
        eleven log info "verify checksum of ${GITHUB_ASSET} ..."
        echo "${GITHUB_ASSET_SHA256} ${GITHUB_ASSET}" | sha256sum -c &> /dev/null
      else
        eleven log warning "could not get sha256 checksum for ${1}"
      fi

      if echo ${GITHUB_ASSET_EXTENSION} | grep -qE "xz|gz|tar|rar|7z"; then
        eleven log info "unpacking ${GITHUB_ASSET} ..."
        /usr/local/bin/pv ${GITHUB_ASSET} | tar xz;
      elif echo ${GITHUB_ASSET_EXTENSION} | grep -qE "zip"; then
        eleven log info "unzipping ${GITHUB_ASSET} ..."
        unzip ${GITHUB_ASSET};
      fi
    ;;

    *) 
      eleven log warning "function ${FN} does not exist"
      exit 1
    ;;
  esac